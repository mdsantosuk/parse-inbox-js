<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>ParseInbox - Focuses on parsing inbox messages for relevant details</title>
  <link rel="stylesheet" href="styles.css" />
  <style>
    :root{
      --bg: #efefef;
      --panel: #f7f7f7;
      --border: #cfcfcf;
      --text: #111;
      --muted: #555;
      --white: #fff;
      --blue: #2c5cff;
    }

    *{ box-sizing: border-box; font-family: Segoe UI, Tahoma, Arial, sans-serif; }
    body{ margin:0; background: var(--bg); color: var(--text); }

    .window{
      width: min(1400px, 98vw);
      margin: 14px auto;
      padding: 8px;
    }

    .app{
      display: grid;
      grid-template-columns: 1.1fr 1fr;
      gap: 14px;
      align-items: start;
    }

    .left, .right{ min-height: 86vh; }

    .left{
      background: transparent;
      padding: 6px;
    }

    .left h2{
      margin: 6px 0 10px;
      text-align: center;
      font-size: 20px;
      font-weight: 600;
    }

    #emailInput{
      width: 100%;
      height: calc(86vh - 110px);
      border: 1px solid var(--border);
      background: var(--white);
      padding: 10px;
      resize: none;
      outline: none;
      font-size: 14px;
      line-height: 1.35;
      white-space: pre-wrap;
    }

    .left-actions{
      display: flex;
      justify-content: center;
      margin-top: 12px;
    }

    .right{
      padding: 6px;
      position: relative;
    }

    .panel{
      border: 1px solid var(--border);
      background: var(--panel);
      margin-bottom: 12px;
    }

    .panel-title{
      padding: 10px 12px;
      font-weight: 600;
      border-bottom: 1px solid var(--border);
    }

    .info-rows{
      padding: 10px 12px;
    }

    .info-row{
      display: grid;
      grid-template-columns: 140px 1fr 86px;
      gap: 10px;
      align-items: center;
      padding: 6px 0;
    }

    .label{
      color: var(--muted);
      font-size: 13px;
    }

    .value{
      font-weight: 600;
      font-size: 14px;
      min-height: 18px;
    }

    .value.wrap{
      font-weight: 600;
      line-height: 1.25;
    }

    .btn{
      border: 1px solid var(--border);
      background: var(--white);
      padding: 7px 10px;
      border-radius: 6px;
      cursor: pointer;
      font-weight: 600;
    }

    .btn:active{ transform: translateY(1px); }

    .btn.primary{
      padding: 9px 22px;
    }

    .table-wrap{
      background: var(--white);
      border-top: 1px solid var(--border);
      max-height: 260px;
      overflow: auto;
    }

    .table{
      width: 100%;
      border-collapse: collapse;
      font-size: 14px;
    }

    .table thead th{
      position: sticky;
      top: 0;
      background: #ffffff;
      border-bottom: 1px solid var(--border);
      padding: 8px;
      text-align: left;
      font-weight: 700;
    }

    .table tbody td{
      border-bottom: 1px solid #e8e8e8;
      padding: 7px 8px;
    }

    .table tbody tr{
      cursor: pointer;
    }

    .table tbody tr:hover{
      background: #f5f9ff;
    }

    .table tbody tr.selected{
      outline: 2px solid var(--blue);
      outline-offset: -2px;
      background: #f0f6ff;
    }

    .details{
      padding: 10px 12px;
    }

    .detail-row{
      display: grid;
      grid-template-columns: 120px 1fr 86px;
      gap: 10px;
      align-items: center;
      padding: 7px 0;
    }

    .field{
      width: 100%;
      border: 1px solid var(--border);
      background: var(--white);
      padding: 7px 8px;
      border-radius: 4px;
      font-size: 14px;
    }

    .footer-tag{
      position: absolute;
      right: 10px;
      bottom: 6px;
      font-weight: 600;
      color: #666;
      font-size: 12px;
    }

    .toast{
      position: fixed;
      left: 50%;
      bottom: 18px;
      transform: translateX(-50%);
      background: #111;
      color: #fff;
      padding: 10px 14px;
      border-radius: 10px;
      opacity: 0;
      pointer-events: none;
      transition: opacity .18s ease;
      font-size: 13px;
    }
    .toast.show{ opacity: 0.95; }

    @media (max-width: 980px){
      .app{ grid-template-columns: 1fr; }
      #emailInput{ height: 40vh; }
    }

  </style>
</head>
<body>
  <div class="window">
    <div class="app">
      <!-- LEFT -->
      <section class="left">
        <h2>Paste Email Content:</h2>
        <textarea id="emailInput" spellcheck="false" placeholder="Paste the email content here..."></textarea>

        <div class="left-actions">
          <button id="extractBtn" class="btn primary">Extract</button>
        </div>
      </section>

      <!-- RIGHT -->
      <section class="right">

        <!-- Users -->
        <div class="panel">
          <div class="panel-title">Users</div>

          <div class="table-wrap" role="region" aria-label="Users table" tabindex="0">
            <table class="table" id="usersTable">
              <thead>
                <tr>
                  <th style="width: 22%;">First Name</th>
                  <th style="width: 22%;">Last Name</th>
                  <th style="width: 36%;">Email</th>
                  <th style="width: 20%;">Phone</th>
                </tr>
              </thead>
              <tbody id="usersTbody">
                <!-- injected -->
              </tbody>
            </table>
          </div>
        </div>

        <!-- General Info -->
        <div class="panel">
          <div class="panel-title">General Information</div>

            <div class="info-row">
              <div class="label">Client Name</div>
              <div id="giClientName" class="value"></div>
              <button class="btn copy" data-copy-target="giClientName">Copy</button>
            </div>

            <div class="info-row">
              <div class="label">Contract Name</div>
              <div id="giContractName" class="value"></div>
              <button class="btn copy" data-copy-target="giContractName">Copy</button>
            </div>

            <div class="info-row">
              <div class="label">Contract ID</div>
              <div id="giContractId" class="value"></div>
              <button class="btn copy" data-copy-target="giContractId">Copy</button>
            </div>

            <div class="info-row">
              <div class="label">Access Level</div>
              <div id="giAccessLevel" class="value wrap"></div>
              <button class="btn copy" data-copy-target="giAccessLevel">Copy</button>
            </div>
          </div>
        </div>


        <!-- User Details -->
        <div class="panel">
          <div class="panel-title">User Details</div>

          <div class="details">
            <div class="detail-row">
              <div class="label">Full Name</div>
              <input id="udFullName" class="field" readonly />
              <button class="btn copy" data-copy-target="udFullName">Copy</button>
            </div>

            <div class="detail-row">
              <div class="label">First Name</div>
              <input id="udFirstName" class="field" readonly />
              <button class="btn copy" data-copy-target="udFirstName">Copy</button>
            </div>

            <div class="detail-row">
              <div class="label">Last Name</div>
              <input id="udLastName" class="field" readonly />
              <button class="btn copy" data-copy-target="udLastName">Copy</button>
            </div>

            <div class="detail-row">
              <div class="label">Email</div>
              <input id="udEmail" class="field" readonly />
              <button class="btn copy" data-copy-target="udEmail">Copy</button>
            </div>

            <div class="detail-row">
              <div class="label">Phone</div>
              <input id="udPhone" class="field" readonly />
              <button class="btn copy" data-copy-target="udPhone">Copy</button>
            </div>
          </div>
        </div>

        <div class="footer-tag">msantosuk</div>
      </section>
    </div>

    <div id="toast" class="toast" aria-live="polite"></div>
  </div>

  <script>
    const emailInput = document.getElementById("emailInput");
    const extractBtn = document.getElementById("extractBtn");

    const gi = {
      requestorEmail: document.getElementById("giRequestorEmail"),
      clientName: document.getElementById("giClientName"),
      contractName: document.getElementById("giContractName"),
      contractId: document.getElementById("giContractId"),
      accessLevel: document.getElementById("giAccessLevel"),
    };

    const ud = {
      fullName: document.getElementById("udFullName"),
      firstName: document.getElementById("udFirstName"),
      lastName: document.getElementById("udLastName"),
      email: document.getElementById("udEmail"),
      phone: document.getElementById("udPhone"),
    };

    const usersTbody = document.getElementById("usersTbody");
    const toastEl = document.getElementById("toast");

    let currentUsers = [];
    let selectedIndex = -1;

    const LABEL_MATCHERS = [
      { key: "requestorEmail", re: /^\s*requestor\s*email\s*:\s*(.*)\s*$/i },
      { key: "clientName", re: /^\s*client\s*name\s*:\s*(.*)\s*$/i },
      { key: "userFullName", re: /^\s*user\s*full\s*name\s*:\s*(.*)\s*$/i },
      { key: "userEmailAddress", re: /^\s*user\s*email\s*address\s*:\s*(.*)\s*$/i },
      { key: "userPhoneNumber", re: /^\s*user\s*phone\s*number\s*:\s*(.*)\s*$/i },
      { key: "companyDomain", re: /^\s*company\s*domain\s*:\s*(.*)\s*$/i },
      { key: "accessLevel", re: /^\s*which\s*level\s*does\s*the\s*user\s*need\s*access\s*to\?\s*:\s*(.*)\s*$/i },
      { key: "contractName", re: /^\s*contract\s*name\s*:\s*(.*)\s*$/i },
      { key: "contractId", re: /^\s*contract\s*id\s*:\s*(.*)\s*$/i },
    ];

    function normalizeLines(raw) {
      return raw
        .replace(/\r\n/g, "\n")
        .replace(/\r/g, "\n")
        .split("\n")
        .map(l => l.trim())
        .filter(l => l.length > 0);
    }

    function parseToSections(raw) {
      const lines = normalizeLines(raw);
      const sections = {};
      let currentKey = null;

      for (const line of lines) {
        let matched = false;

        for (const m of LABEL_MATCHERS) {
          const mm = line.match(m.re);
          if (mm) {
            matched = true;
            currentKey = m.key;
            if (!sections[currentKey]) sections[currentKey] = [];
            const rest = (mm[1] || "").trim();
            if (rest) sections[currentKey].push(rest);
            break;
          }
        }

        if (!matched && currentKey) {
          sections[currentKey].push(line);
        }
      }

      return sections;
    }

    function firstEmailFrom(text) {
      const m = (text || "").match(/[A-Z0-9._%+-]+@[A-Z0-9.-]+\.[A-Z]{2,}/i);
      return m ? m[0].trim() : "";
    }

    function allEmailsFrom(text) {
      const matches = (text || "").match(/[A-Z0-9._%+-]+@[A-Z0-9.-]+\.[A-Z]{2,}/gi);
      return matches ? matches.map(x => x.trim()) : [];
    }

    function allPhonesFrom(text) {
      // Only digits sequences >= 8 (good for UK/mobile etc.)
      const matches = (text || "").match(/\b\d{8,}\b/g);
      return matches ? matches.map(x => x.trim()) : [];
    }

    function namesFrom(sectionLines) {
      if (!sectionLines || sectionLines.length === 0) return [];
      // Each line is typically one full name (First Last) â€“ keep as-is
      return sectionLines
        .map(x => x.trim())
        .filter(Boolean);
    }

    function splitFirstLast(fullName) {
      const parts = (fullName || "").trim().split(/\s+/).filter(Boolean);
      if (parts.length === 0) return { first: "", last: "" };
      if (parts.length === 1) return { first: parts[0], last: "" };
      return { first: parts[0], last: parts[parts.length - 1] };
    }

    function parseEmailContent(raw) {
      const sections = parseToSections(raw);

      const requestorEmail = firstEmailFrom((sections.requestorEmail || []).join(" "));
      const clientName = (sections.clientName || []).join(" ").trim();

      const accessLevel = (sections.accessLevel || []).join(" ").trim();

      const contractNameRaw = (sections.contractName || []).join(" ").trim();
      const contractIdRaw = (sections.contractId || []).join(" ").trim();

      const contractName = contractNameRaw ? contractNameRaw : "N/A";
      const contractId = contractIdRaw ? contractIdRaw : "N/A";

      const fullNames = namesFrom(sections.userFullName || []);
      const emails = allEmailsFrom((sections.userEmailAddress || []).join(" "));
      const phones = allPhonesFrom((sections.userPhoneNumber || []).join(" "));

      const count = Math.max(fullNames.length, emails.length, phones.length, 0);
      const users = [];

      for (let i = 0; i < count; i++) {
        const fullName = fullNames[i] || "";
        const { first, last } = splitFirstLast(fullName);

        users.push({
          fullName,
          firstName: first,
          lastName: last,
          email: emails[i] || "",
          phone: phones[i] || "",
        });
      }

      return {
        general: {
          requestorEmail,
          clientName,
          contractName,
          contractId,
          accessLevel,
        },
        users,
      };
    }

    function setText(el, text) {
      el.textContent = (text ?? "").toString();
    }

    function setInput(el, text) {
      el.value = (text ?? "").toString();
    }

    function renderGeneralInfo(general) {
      setText(gi.requestorEmail, general.requestorEmail || "");
      setText(gi.clientName, general.clientName || "");
      setText(gi.contractName, general.contractName || "N/A");
      setText(gi.contractId, general.contractId || "N/A");
      setText(gi.accessLevel, general.accessLevel || "");
    }

    function clearUsersUI() {
      usersTbody.innerHTML = "";
      setInput(ud.fullName, "");
      setInput(ud.firstName, "");
      setInput(ud.lastName, "");
      setInput(ud.email, "");
      setInput(ud.phone, "");
      selectedIndex = -1;
    }

    function renderUsersTable(users) {
      usersTbody.innerHTML = "";

      if (!users || users.length === 0) {
        const tr = document.createElement("tr");
        tr.innerHTML = `<td colspan="4" style="padding:10px;color:#777;">No users found</td>`;
        usersTbody.appendChild(tr);
        return;
      }

      users.forEach((u, idx) => {
        const tr = document.createElement("tr");
        tr.dataset.index = String(idx);
        tr.innerHTML = `
          <td>${escapeHtml(u.firstName)}</td>
          <td>${escapeHtml(u.lastName)}</td>
          <td>${escapeHtml(u.email)}</td>
          <td>${escapeHtml(u.phone)}</td>
        `;
        usersTbody.appendChild(tr);
      });
    }

    function selectUser(index) {
      if (!currentUsers || currentUsers.length === 0) return;
      if (index < 0 || index >= currentUsers.length) return;

      selectedIndex = index;

      [...usersTbody.querySelectorAll("tr")].forEach(tr => tr.classList.remove("selected"));
      const row = usersTbody.querySelector(`tr[data-index="${index}"]`);
      if (row) row.classList.add("selected");

      const u = currentUsers[index];

      setInput(ud.fullName, u.fullName || "");
      setInput(ud.firstName, u.firstName || "");
      setInput(ud.lastName, u.lastName || "");
      setInput(ud.email, u.email || "");
      setInput(ud.phone, u.phone || "");
    }

    function escapeHtml(str) {
      return (str ?? "").toString()
        .replaceAll("&", "&amp;")
        .replaceAll("<", "&lt;")
        .replaceAll(">", "&gt;")
        .replaceAll('"', "&quot;")
        .replaceAll("'", "&#039;");
    }

    function showToast(msg) {
      toastEl.textContent = msg;
      toastEl.classList.add("show");
      window.clearTimeout(showToast._t);
      showToast._t = window.setTimeout(() => toastEl.classList.remove("show"), 1200);
    }

    async function copyText(text) {
      const value = (text ?? "").toString();

      // Try modern clipboard API first (may fail on file:// depending on browser policy)
      try {
        await navigator.clipboard.writeText(value);
        return true;
      } catch {
        // Fallback works well for local file usage
        try {
          const ta = document.createElement("textarea");
          ta.value = value;
          ta.setAttribute("readonly", "");
          ta.style.position = "fixed";
          ta.style.left = "-9999px";
          document.body.appendChild(ta);
          ta.select();
          const ok = document.execCommand("copy");
          document.body.removeChild(ta);
          return ok;
        } catch {
          return false;
        }
      }
    }

    function getCopyTargetValue(targetId) {
      const el = document.getElementById(targetId);
      if (!el) return "";

      if (el.tagName === "INPUT" || el.tagName === "TEXTAREA") return el.value;
      return el.textContent;
    }

    /* Events */

    extractBtn.addEventListener("click", () => {
      const raw = emailInput.value || "";
      if (!raw.trim()) {
        clearUsersUI();
        renderGeneralInfo({
          requestorEmail: "",
          clientName: "",
          contractName: "N/A",
          contractId: "N/A",
          accessLevel: "",
        });
        showToast("Paste an email first");
        return;
      }

      const result = parseEmailContent(raw);
      currentUsers = result.users;

      renderGeneralInfo(result.general);
      renderUsersTable(currentUsers);

      // auto-select first user
      if (currentUsers.length > 0) selectUser(0);
      else clearUsersUI();

      showToast("Extracted");
    });

    usersTbody.addEventListener("click", (e) => {
      const tr = e.target.closest("tr");
      if (!tr || !tr.dataset.index) return;
      const idx = Number(tr.dataset.index);
      selectUser(idx);
    });

    document.addEventListener("click", async (e) => {
      const btn = e.target.closest(".copy");
      if (!btn) return;

      const targetId = btn.getAttribute("data-copy-target");
      const val = getCopyTargetValue(targetId);

      const ok = await copyText(val);
      showToast(ok ? "Copied" : "Copy failed");
    });
  </script>
</body>
</html>